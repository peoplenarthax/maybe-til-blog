---
// Pull Chain Theme Toggle Component
---

<!-- Pull Chain Container (hidden on small screens) -->
<div
  id="pull-chain-container"
  class="fixed top-0 right-8 z-[100] select-none hidden md:block"
  aria-label="Pull chain to toggle theme"
>
  <!-- Movable Chain Section (goes behind ceiling mount) -->
  <div
    id="movable-chain"
    class="flex flex-col items-center relative z-10"
    style="margin-top: -2px;"
  >
    <!-- Chain Links -->
    <div
      id="chain-links"
      class="flex flex-col items-center"
      style="margin-top: -40px;"
    >
      <div
        class="chain-link bg-accent-600 dark:bg-primary-300 w-1 h-3 rounded-full mb-0.5 transition-all duration-300 opacity-0 -translate-y-6"
      >
      </div>
      <div
        class="chain-link bg-accent-600 dark:bg-primary-300 w-1 h-3 rounded-full mb-0.5 transition-all duration-300 opacity-0 -translate-y-4"
      >
      </div>
      <div
        class="chain-link bg-accent-600 dark:bg-primary-300 w-1 h-3 rounded-full mb-0.5 transition-all duration-300 opacity-0 -translate-y-2"
      >
      </div>

      <!-- Visible chain links (close to ceiling mount) -->
      <div
        class="chain-link bg-accent-600 dark:bg-primary-300 w-1 h-3 rounded-full mb-0.5 transition-all duration-300"
      >
      </div>
      <div
        class="chain-link bg-accent-600 dark:bg-primary-300 w-1 h-3 rounded-full mb-0.5 transition-all duration-300"
      >
      </div>
      <div
        class="chain-link bg-accent-600 dark:bg-primary-300 w-1 h-3 rounded-full mb-0.5 transition-all duration-300"
      >
      </div>
      <div
        class="chain-link bg-accent-600 dark:bg-primary-300 w-1 h-3 rounded-full mb-0.5 transition-all duration-300"
      >
      </div>
      <div
        class="chain-link bg-accent-600 dark:bg-primary-300 w-1 h-3 rounded-full mb-0.5 transition-all duration-300"
      >
      </div>
      <div
        class="chain-link bg-accent-600 dark:bg-primary-300 w-1 h-3 rounded-full mb-0.5 transition-all duration-300"
      >
      </div>
    </div>

    <!-- Pull Ball with Sun/Moon -->
    <button
      id="pull-chain-toggle"
      type="button"
      class="relative w-8 h-8 bg-gradient-to-br from-primary-400 to-primary-600 dark:from-accent-500 dark:to-accent-800 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 cursor-pointer"
    >
      <!-- Sun icon (visible in light mode) -->
      <svg
        id="sun-icon"
        class="absolute inset-1 w-6 h-6 text-white drop-shadow-sm"
        fill="currentColor"
        viewBox="0 0 20 20"
      >
        <path
          fill-rule="evenodd"
          d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
          clip-rule="evenodd"></path>
      </svg>

      <!-- Moon icon (visible in dark mode) -->
      <svg
        id="moon-icon"
        class="hidden absolute inset-1 w-6 h-6 text-white drop-shadow-sm"
        fill="currentColor"
        viewBox="0 0 20 20"
      >
        <path
          d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
        ></path>
      </svg>
    </button>
  </div>

  <!-- Ceiling Mount (stays fixed and in front) -->
  <div
    class="absolute top-0 left-1/2 transform -translate-x-1/2 w-3 h-2 bg-accent-700 dark:bg-primary-400 rounded-b-sm z-20"
  >
  </div>
</div>

<style>
  /* Pull Chain Animation Styles */
  .pull-chain-pull {
    animation: pullChainDown 0.3s ease-out forwards;
  }

  .pull-chain-release {
    animation: pullChainRelease 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55)
      forwards;
  }

  @keyframes pullChainDown {
    0% {
      transform: translateY(0px) scale(1);
    }
    100% {
      transform: translateY(20px) scale(0.95);
    }
  }

  @keyframes pullChainRelease {
    0% {
      transform: translateY(20px) scale(0.95);
    }
    50% {
      transform: translateY(-10px) scale(1.05);
    }
    100% {
      transform: translateY(0px) scale(1);
    }
  }

  /* Chain link subtle animations */
  .chain-link {
    transition: all 0.3s ease;
    transform-origin: top center;
  }

  /* Hidden links become visible when pulling */
  .pulling .chain-link:nth-child(1),
  .pulling .chain-link:nth-child(2),
  .pulling .chain-link:nth-child(3) {
    opacity: 1 !important;
    transform: translateY(0px) !important;
  }

  .pulling .chain-link:nth-child(1) {
    animation-delay: 0s;
  }
  .pulling .chain-link:nth-child(2) {
    animation-delay: 0.02s;
  }
  .pulling .chain-link:nth-child(3) {
    animation-delay: 0.04s;
  }
  .pulling .chain-link:nth-child(4) {
    animation-delay: 0.06s;
  }
  .pulling .chain-link:nth-child(5) {
    animation-delay: 0.08s;
  }
  .pulling .chain-link:nth-child(6) {
    animation-delay: 0.1s;
  }
  .pulling .chain-link:nth-child(7) {
    animation-delay: 0.12s;
  }
  .pulling .chain-link:nth-child(8) {
    animation-delay: 0.14s;
  }
  .pulling .chain-link:nth-child(9) {
    animation-delay: 0.16s;
  }

  .pulling .chain-link {
    animation: chainLinkStretch 0.3s ease-out forwards;
  }

  @keyframes chainLinkStretch {
    0% {
      transform: scaleY(1) translateY(0px);
      height: 0.75rem; /* h-3 */
      margin-bottom: 0.125rem; /* mb-0.5 */
    }
    100% {
      transform: scaleY(1.6) translateY(2px);
      height: 1rem; /* h-4 */
      margin-bottom: 0.25rem; /* mb-1 */
    }
  }

  /* Chain return animation */
  .pulling.returning .chain-link {
    animation: chainLinkReturn 0.4s ease-in-out forwards;
  }

  .pulling.returning .chain-link:nth-child(1),
  .pulling.returning .chain-link:nth-child(2),
  .pulling.returning .chain-link:nth-child(3) {
    opacity: 0 !important;
    transform: translateY(-6px) scaleY(1) !important;
  }

  @keyframes chainLinkReturn {
    0% {
      transform: scaleY(1.6) translateY(2px);
      height: 1rem;
      margin-bottom: 0.25rem;
    }
    100% {
      transform: scaleY(1) translateY(0px);
      height: 0.75rem;
      margin-bottom: 0.125rem;
    }
  }

  /* Ball glow effects */
  .theme-sun {
    box-shadow: 0 0 20px rgba(64, 130, 109, 0.4); /* viridian glow */
  }

  .theme-moon {
    box-shadow: 0 0 20px rgba(125, 91, 166, 0.4); /* royal-purple glow */
  }
</style>

<script>
  // Pull Chain Theme Toggle functionality
  function initializePullChainToggle() {
    const sunIcon = document.getElementById("sun-icon");
    const moonIcon = document.getElementById("moon-icon");
    const pullChainBtn = document.getElementById("pull-chain-toggle");
    const movableChain = document.getElementById("movable-chain");
    const chainLinks = document.getElementById("chain-links");

    // Mobile toggle elements
    const mobileSunIcon = document.getElementById("mobile-sun-icon");
    const mobileMoonIcon = document.getElementById("mobile-moon-icon");
    const mobileToggleBtn = document.getElementById("mobile-theme-toggle");

    if (
      !sunIcon ||
      !moonIcon ||
      !pullChainBtn ||
      !movableChain ||
      !chainLinks
    ) {
      return;
    }

    // Get theme from localStorage or default to system preference
    function getStoredTheme() {
      return localStorage.getItem("theme");
    }

    function getSystemPreference() {
      return window.matchMedia("(prefers-color-scheme: dark)").matches
        ? "dark"
        : "light";
    }

    function getCurrentTheme(): "dark" | "light" {
      const theme = getStoredTheme() || getSystemPreference();
      return theme as "dark" | "light";
    }

    // Set theme and update chain appearance
    function setTheme(theme: "dark" | "light") {
      if (theme === "dark") {
        document.documentElement.classList.add("dark");
        // Update pull chain icons
        sunIcon?.classList.add("hidden");
        moonIcon?.classList.remove("hidden");
        pullChainBtn?.classList.remove("theme-sun");
        pullChainBtn?.classList.add("theme-moon");
        // Update mobile icons (match pull chain - show current theme)
        mobileSunIcon?.classList.add("hidden");
        mobileMoonIcon?.classList.remove("hidden");
      } else {
        document.documentElement.classList.remove("dark");
        // Update pull chain icons
        sunIcon?.classList.remove("hidden");
        moonIcon?.classList.add("hidden");
        pullChainBtn?.classList.remove("theme-moon");
        pullChainBtn?.classList.add("theme-sun");
        // Update mobile icons (match pull chain - show current theme)
        mobileSunIcon?.classList.remove("hidden");
        mobileMoonIcon?.classList.add("hidden");
      }
      localStorage.setItem("theme", theme);
    }

    // Pull chain animation (only affects movable parts)
    function triggerPullAnimation() {
      // Add pulling class to chain links for staggered stretch effect
      chainLinks?.classList.add("pulling");

      // Add pull animation to only the movable chain section
      movableChain?.classList.add("pull-chain-pull");

      setTimeout(() => {
        movableChain?.classList.remove("pull-chain-pull");
        movableChain?.classList.add("pull-chain-release");

        // Add returning class for chain link return animation
        chainLinks?.classList.add("returning");

        setTimeout(() => {
          movableChain?.classList.remove("pull-chain-release");
          chainLinks?.classList.remove("pulling", "returning");
        }, 600);
      }, 300);
    }

    // Initialize theme
    const currentTheme = getCurrentTheme();
    setTheme(currentTheme);

    // Toggle theme on pull chain click
    pullChainBtn.addEventListener("click", () => {
      const currentTheme = document.documentElement.classList.contains("dark")
        ? "dark"
        : "light";
      const newTheme = currentTheme === "dark" ? "light" : "dark";

      // Trigger pull animation
      triggerPullAnimation();

      // Change theme after a short delay for better visual effect
      setTimeout(() => {
        setTheme(newTheme);
      }, 150);
    });

    // Toggle theme on mobile button click (no animation)
    mobileToggleBtn?.addEventListener("click", () => {
      const currentTheme = document.documentElement.classList.contains("dark")
        ? "dark"
        : "light";
      const newTheme = currentTheme === "dark" ? "light" : "dark";
      setTheme(newTheme);
    });

    // Listen for system preference changes
    window
      .matchMedia("(prefers-color-scheme: dark)")
      .addEventListener("change", (e) => {
        if (!getStoredTheme()) {
          setTheme(e.matches ? "dark" : "light");
        }
      });
  }

  // Initialize when DOM is ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initializePullChainToggle);
  } else {
    initializePullChainToggle();
  }

  // Re-initialize when navigating (for SPA-like behavior)
  document.addEventListener("astro:page-load", initializePullChainToggle);
</script>
